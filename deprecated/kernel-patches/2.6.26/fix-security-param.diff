From: John Johansen <jjohansen@suse.de>
Subject: fix recognition of security= boot parameter
Patch-mainline: no
References: bnc#442668

Fix AppArmor to respect the kernel boot parameter security=, so that if a
different lsm is choosen apparmor does not try to register its lsm hooks.

Signed-off-by: John Johansen <jjohansen@suse.de>

---
 security/apparmor/lsm.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/security/apparmor/lsm.c
+++ b/security/apparmor/lsm.c
@@ -964,6 +964,7 @@ int apparmor_unregister_subsecurity(cons
 }
 
 struct security_operations apparmor_ops = {
+	.name =                         "apparmor",
 	.ptrace =			apparmor_ptrace,
 	.capget =			cap_capget,
 	.capset_check =			cap_capset_check,
@@ -1042,8 +1043,8 @@ static int __init apparmor_init(void)
 {
 	int error;
 
-	if (!apparmor_enabled) {
-		info_message("AppArmor disabled by boottime parameter", "");
+	if (!apparmor_enabled || !security_module_enable(&apparmor_ops)) {
+		info_message("AppArmor disabled by boot time parameter", "");
 		return 0;
 	}
 
