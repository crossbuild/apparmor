From: John Johansen <jjohansen@suse.de>
Subject: fix recognition of security= boot parameter
Patch-mainline: no
References: bnc#442668

Fix AppArmor to respect the kernel boot parameter security=, so that if a
different lsm is choosen apparmor does not try to register its lsm hooks.

Signed-off-by: John Johansen <jjohansen@suse.de>

---
 security/apparmor/lsm.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/security/apparmor/lsm.c
+++ b/security/apparmor/lsm.c
@@ -911,6 +911,7 @@ static int apparmor_task_setrlimit(unsig
 }
 
 struct security_operations apparmor_ops = {
+	.name =				"apparmor",
 	.ptrace_may_access =		apparmor_ptrace_may_access,
 	.ptrace_traceme =		apparmor_ptrace_traceme,
 	.capget =			cap_capget,
@@ -989,8 +990,8 @@ static int __init apparmor_init(void)
 {
 	int error;
 
-	if (!apparmor_enabled) {
-		info_message("AppArmor disabled by boottime parameter\n");
+	if (!apparmor_enabled || !security_module_enable(&apparmor_ops)) {
+		info_message("AppArmor disabled by boot time parameter\n");
 		return 0;
 	}
 
